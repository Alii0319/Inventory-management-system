<!DOCTYPE html>
<html>
<head>
    <title>Sales Report</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="p-4">

    <h2>Sales Report</h2>

    <!-- Filters -->
    <form id="filter-form" class="row g-3 mb-4">
        <div class="col-auto">
            <label for="start_date" class="form-label">Start Date</label>
            <input type="date" class="form-control" id="start_date">
        </div>
        <div class="col-auto">
            <label for="end_date" class="form-label">End Date</label>
            <input type="date" class="form-control" id="end_date">
        </div>
        <div class="col-auto align-self-end">
            <button type="submit" class="btn btn-primary">Filter</button>
        </div>
    </form>

    <!-- Table -->
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Product Name</th>
                <th>Quantity Sold</th>
                <th>Total Earned</th>
            </tr>
        </thead>
        <tbody id="report-body">
            <!-- Filled by JS -->
        </tbody>
    </table>

    <p><strong>Total Quantity:</strong> <span id="total-qty">0</span></p>
    <p><strong>Total Revenue:</strong> <span id="total-rev">0</span></p>

    <!-- Chart -->
    <div class="mt-5">
        <h4>Sales Chart (Quantity per Product)</h4>
        <canvas id="salesChart" height="100"></canvas>
    </div>

    <script>
        const form = document.getElementById('filter-form');
        const reportBody = document.getElementById('report-body');
        const totalQty = document.getElementById('total-qty');
        const totalRev = document.getElementById('total-rev');
        let salesChart;

        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const start = document.getElementById('start_date').value;
            const end = document.getElementById('end_date').value;

            let url = '/api/sales-report/';
            let params = [];

            if (start) params.push(`start_date=${start}`);
            if (end) params.push(`end_date=${end}`);
            if (params.length) url += '?' + params.join('&');

            fetch(url)
                .then(res => res.json())
                .then(data => {
                    totalQty.textContent = data.total_quantity;
                    totalRev.textContent = data.total_revenue;

                    let rows = '';
                    const labels = [];
                    const quantities = [];

                    data.product_sales.forEach(item => {
                        rows += `<tr>
                            <td>${item.product_name}</td>
                            <td>${item.quantity_sold}</td>
                            <td>${item.total_earned}</td>
                        </tr>`;
                        labels.push(item.product_name);
                        quantities.push(item.quantity_sold);
                    });

                    reportBody.innerHTML = rows;

                    // Update Chart
                    if (salesChart) {
                        salesChart.destroy();
                    }

                    const ctx = document.getElementById('salesChart').getContext('2d');
                    salesChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Quantity Sold',
                                data: quantities,
                                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                });
        });

        // Load initial data
        form.dispatchEvent(new Event('submit'));
    </script>

</body>
</html>
